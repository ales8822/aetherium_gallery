<!-- templates/partials/gallery_item_loop.html (DEFINITIVE FINAL VERSION) -->

{% for image in images %}
  <div
    class="gallery-item"
    data-id="{{ image.id }}"
  >
    <!-- We'll keep the debug overlay for now, you can remove it later -->
    <div class="order-index-debug" title="Database Order Index">{{ image.order_index }}</div>
    
    <a
      href="{{ url_for('image_detail', image_id=image.id) }}"
      data-full-image-url="{% if image.video_source %}{{ url_for('uploads', path=image.video_source.filepath) }}{% else %}{{ url_for('uploads', path=image.filepath) }}{% endif %}"
      class="gallery-link"
      {% if image.video_source %}
        data-is-video="true"
        data-video-type="{{ image.video_source.content_type }}"
      {% endif %}
    >
        {% if image.thumbnail_path %}
        <img src="{{ url_for('uploads', path=image.thumbnail_path) }}" alt="{{ image.original_filename or 'Uploaded Image' }}" loading="lazy" />
        {% else %}
        <img src="{{ url_for('uploads', path=image.filepath) }}" alt="{{ image.original_filename or 'Uploaded Image' }}" loading="lazy" />
        {% endif %}

        {% if image.video_source %}
        <div class="video-indicator-overlay">
          <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 0 24 24" width="48px" fill="#ffffff"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        </div>
        {% endif %}

        <div class="overlay">
            <p class="filename">{{ image.original_filename or image.filename }}</p>
        </div>
    </a>

    <div class="selection-overlay"></div>
    <div class="selection-checkbox">
      <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="white"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
    </div>
  
    <!-- ▼▼▼ RE-INTRODUCING THE CORRECT ICONS CONTAINER ▼▼▼ -->
    <div class="persistent-icons">
        <!-- Resolution -->
        {% if image.width and image.height %}
        <div class="image-resolution">
            <span>{{ image.width }}x{{ image.height }}</span>
        </div>
        {% endif %}
        
        <!-- NEW: Find Similar Button -->
        {% if not image.video_source %}
        <a href="{{ url_for('find_similar', image_id=image.id) }}" class="icon-button" title="Find Similar">
            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"/></svg>
        </a>
        {% endif %}
        
        <!-- Info Icon -->
        <div class="info-icon"
             role="button"
             aria-label="Show image metadata"
             data-filename="{{ image.original_filename or image.filename }}"
             data-prompt="{{ image.prompt or '' }}"
             data-negative-prompt="{{ image.negative_prompt or '' }}"
             data-sampler="{{ image.sampler or 'N/A' }}"
             data-steps="{{ image.steps or 'N/A' }}"
             data-cfg="{{ image.cfg_scale or 'N/A' }}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="18px" height="18px"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
        </div>
    </div>
  </div>
{% endfor %}