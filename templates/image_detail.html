<!-- templates/image_detail.html (UPDATED with Selective Generation) -->
{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block head_extra %}
<style>
/* --- Styles for Tags --- */
.tag-list{display:flex;flex-wrap:wrap;gap:.5rem;padding-left:0;margin:0;list-style:none}
.tag-list li a{display:inline-block;background-color:#444;color:#e0e0e0;padding:.2rem .6rem;border-radius:4px;font-size:.85em;text-decoration:none;border:1px solid #555;transition:all .2s ease}
.tag-list li a:hover{background-color:#64b5f6;color:#111;border-color:#64b5f6}

/* ▼▼▼ UPDATED STYLES FOR INLINE BUTTONS ▼▼▼ */
.dd-content{display:flex;align-items:center;gap:8px;word-break:break-all}
.copy-button, .generate-inline-button {
    background-color:transparent;
    border:none;
    color:#888;
    cursor:pointer;
    padding:2px;
    border-radius:4px;
    display:flex;
    align-items:center;
    flex-shrink:0;
    transition:all .2s ease
}
.copy-button:hover, .generate-inline-button:hover { color:#64b5f6 }
.copy-button:disabled, .generate-inline-button:disabled { color:#555; cursor: not-allowed; }
.copy-button svg, .generate-inline-button svg { fill:currentColor; width:18px; height:18px }
.generate-inline-button[data-source="gemini"] svg { width: 24px; height: 24px; }
.metadata-editor.edit-mode .copy-button, 
.metadata-editor.edit-mode .generate-inline-button { display:none }
.generate-inline-button.loading svg { animation: spin 1s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<h1>Image Details</h1>

<div class="image-detail-container">
    <div class="image-view">
        {% if image.video_source %}
        <video controls autoplay muted loop playsinline poster="{{ url_for('uploads', path=image.thumbnail_path) }}" style="width: 100%; height: auto; border-radius: 8px;">
            <source src="{{ url_for('uploads', path=image.video_source.filepath) }}" type="{{ image.video_source.content_type }}">
            Your browser does not support the video tag.
        </video>
        {% else %}
        <img src="{{ url_for('uploads', path=image.filepath) }}" alt="{{ image.original_filename or 'Image' }}" />
        {% endif %}
    </div>

    <div id="metadata-editor-panel" class="metadata-panel metadata-editor" data-image-id="{{ image.id }}">
        <h2>Metadata</h2>
        <form id="edit-form">
            
            <dl>
                <!-- Static (Non-Editable) Fields -->
                <dt>Filename:</dt>
                <dd><div class="dd-content"><span class="copy-target">{{ image.filename }}</span><button type="button" class="copy-button" title="Copy Filename"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></dd>
                <dt>Original Filename:</dt>
                <dd><div class="dd-content"><span class="copy-target">{{ image.original_filename or 'N/A' }}</span><button type="button" class="copy-button" title="Copy Filename"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></dd>
                
                <!-- ▼▼▼ ADD ALBUM INFO HERE ▼▼▼ -->
                <dt>Album:</dt>
                 <dd>
                    <!-- View mode: Shows a link to the album, or "None" -->
                    <div class="plain-text dd-content">
                        {% if image.album %}
                            <a href="{{ url_for('view_album', album_id=image.album.id) }}">{{ image.album.name }}</a>
                        {% else %}
                            <span>None</span>
                        {% endif %}
                    </div>
                    <!-- Edit mode: Shows a dropdown of all albums -->
                    <select name="album_id" class="form-control">
                        <option value="">-- No Album --</option>
                        {% if all_albums %}
                            {% for album in all_albums %}
                            <option value="{{ album.id }}" {% if image.album and image.album.id == album.id %}selected{% endif %}>
                                {{ album.name }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </dd>

                <!-- Editable Fields -->
                <dt>Tags:</dt>
                <dd>
                    <div class="plain-text dd-content">
                        {% if image.tags %}
                            <ul class="tag-list copy-target" data-copy-text="{{ image.tags | map(attribute='name') | join(', ') }}">
                                {% for tag in image.tags %}
                                <li><a href="{{ url_for('tag_gallery', tag_name=tag.name) }}">{{ tag.name }}</a></li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <span class="copy-target">No tags assigned.</span>
                        {% endif %}
                        <button type="button" class="copy-button" title="Copy Tags"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                        <!-- ▼▼▼ NEW TAGS GENERATION BUTTON ▼▼▼ -->
                        {% if not image.video_source %}
                        <button type="button" class="generate-inline-button" data-source="wd14" title="Generate Tags with WD14 Tagger">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.22-1.05-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/></svg>
                        </button>
                        {% endif %}
                    </div>
                    <input type="text" name="tags" class="form-control" value="{{ image.tags | map(attribute='name') | join(', ') }}">
                </dd>
                
                <dt>Prompt:</dt>
                <dd>
                    <div class="plain-text dd-content">
                        <pre class="copy-target">{{ image.prompt or 'N/A' }}</pre>
                        <button type="button" class="copy-button" title="Copy Prompt"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                        <!-- ▼▼▼ NEW PROMPT GENERATION BUTTON ▼▼▼ -->
                        {% if not image.video_source %}
                        <button type="button" class="generate-inline-button" data-source="gemini" title="Generate Description with Gemini">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M480-80l114-236 236-114-236-114-114-236-114 236L80-530l236 114 114 236Zm0-210L394-460l-170-86 170-86 86-170 86 170 170 86-170 86-86 170Z"/></svg>                        </button>
                        {% endif %}
                    </div>
                    <textarea name="prompt" class="form-control" rows="5">{{ image.prompt or '' }}</textarea>
                </dd>

                <!-- ... Add the dd-content wrapper for ALL other fields ... -->
                
                <dt>Negative Prompt:</dt>
                <dd>
                    <div class="plain-text dd-content">
                        <pre class="copy-target">{{ image.negative_prompt or 'N/A' }}</pre>
                        <button type="button" class="copy-button" title="Copy Negative Prompt"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                    </div>
                    <textarea name="negative_prompt" class="form-control" rows="3">{{ image.negative_prompt or '' }}</textarea>
                </dd>
                
                 <dt>Seed:</dt>
                <dd>
                    <div class="metadata-field-wrapper">
                        <span class="plain-text copy-target">{{ image.seed if image.seed is not none else 'N/A' }}</span>
                        <button class="copy-button" type="button" title="Copy Seed">
                            <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="text" name="seed" class="form-control" value="{{ image.seed or '' }}">
                </dd>
                
                <dt>Steps:</dt>
                <dd>
                    <div class="metadata-field-wrapper">
                        <span class="plain-text copy-target">{{ image.steps if image.steps is not none else 'N/A' }}</span>
                        <button class="copy-button" type="button" title="Copy Steps">
                            <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="number" name="steps" class="form-control" value="{{ image.steps or '' }}">
                </dd>

                <dt>CFG Scale:</dt>
                <dd>
                    <div class="metadata-field-wrapper">
                        <span class="plain-text copy-target">{{ image.cfg_scale if image.cfg_scale is not none else 'N/A' }}</span>
                        <button class="copy-button" type="button" title="Copy CFG Scale">
                            <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="number" step="0.1" name="cfg_scale" class="form-control" value="{{ image.cfg_scale or '' }}">
                </dd>

                <dt>Sampler:</dt>
                <dd>
                    <div class="metadata-field-wrapper">
                        <span class="plain-text copy-target">{{ image.sampler or 'N/A' }}</span>
                        <button class="copy-button" type="button" title="Copy Sampler">
                            <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
                                <path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="text" name="sampler" class="form-control" value="{{ image.sampler or '' }}">
                </dd>

                <dt>Notes:</dt>
                <dd>
                    <div class="plain-text dd-content">
                        <pre class="copy-target">{{ image.notes or 'No notes.' }}</pre>
                        <button type="button" class="copy-button" title="Copy Notes"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                    </div>
                    <textarea name="notes" class="form-control" rows="4">{{ image.notes or '' }}</textarea>
                </dd>
                
                <dt>NSFW Status:</dt>
                <dd>
                    <div class="plain-text dd-content">
                        <span class="copy-target">{{ "Yes" if image.is_nsfw else "No" }}</span>
                        <button type="button" class="copy-button" title="Copy Status"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                    </div>
                    <input name="is_nsfw" class="form-control" type="checkbox" {% if image.is_nsfw %}checked{% endif %} style="width: auto;">
                </dd>
            </dl>
        </form>

    <div class="panel-header">
        <div class="actions">
            <!-- Edit/Save/Cancel buttons -->
            <div id="edit-mode-actions">
                <button type="button" id="edit-button">Edit</button>
                <div class="edit-actions">
                    <button type="button" id="save-button">Save Changes</button>
                    <button type="button" id="cancel-button" class="cancel-button">Cancel</button>
                </div>
            </div>

            {% if not image.video_source %}
            <a href="{{ url_for('find_similar', image_id=image.id) }}" class="button" title="Find Visually Similar Images">Find Similar</a>
            {% endif %}
            <!-- Delete button, always visible -->
            <form action="{{ url_for('delete_image_api_post', image_id=image.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this image? This cannot be undone.');">
                <button type="submit" class="delete-button">Delete</button>
            </form>
        </div>
    </div>
        <div id="status-message" style="margin-top: 1rem; font-weight: bold;"></div>
    </div>
</div>
{% if related_images %}
        <div class="related-images-section">
            <h2 class="section-title">Related Images</h2>
            <!-- 
              We rename 'related_images' to just 'images' for the partial.
              The 'with' statement creates a temporary context for the include.
            -->
            {% with images=related_images %}
                {% include 'partials/gallery_grid.html' %}
            {% endwith %}
        </div>
        {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const editorPanel = document.getElementById('metadata-editor-panel');
    const editButton = document.getElementById('edit-button');
    const saveButton = document.getElementById('save-button');
    const cancelButton = document.getElementById('cancel-button');
    const editForm = document.getElementById('edit-form');
    const statusMessage = document.getElementById('status-message');
    const imageId = editorPanel.dataset.imageId;
    // --- Event Listeners ---
    editButton.addEventListener('click', enterEditMode);
    cancelButton.addEventListener('click', leaveEditMode);
    saveButton.addEventListener('click', saveChanges);

    // ▼▼▼ NEW: Using event delegation for all actions inside the editor panel ▼▼▼
    editorPanel.addEventListener('click', function(event) {
        const generateButton = event.target.closest('.generate-inline-button');
        const copyButton = event.target.closest('.copy-button');
        const editButton = event.target.closest('#edit-button');
        const saveButton = event.target.closest('#save-button');
        const cancelButton = event.target.closest('#cancel-button');
        
        if (generateButton) {
            handleAIGeneration(generateButton);
        } else if (copyButton) {
            handleCopy(copyButton);
        } else if (editButton) {
            enterEditMode();
        } else if (cancelButton) {
            leaveEditMode();
        } else if (saveButton) {
            saveChanges();
        }
    });
    
    // ▼▼▼ NEW: Modular AI generation handler ▼▼▼
    function handleAIGeneration(buttonElement) {
        const source = buttonElement.dataset.source;
        const isPrompt = source === 'gemini';
        const message = isPrompt 
            ? "This will overwrite the current prompt with a new AI-generated description. Are you sure?"
            : "This will add new AI-generated tags to the existing ones. Are you sure?";

        if (!confirm(message)) return;
        
        const originalIconSVG = buttonElement.innerHTML;
        const loadingSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" opacity=".3"/><path d="M12 4a8 8 0 0 1 0 16z"/></svg>`;
        buttonElement.innerHTML = loadingSVG; // Replace icon with a simple spinner for loading
        buttonElement.classList.add('loading');
        buttonElement.disabled = true;

        statusMessage.textContent = `Requesting AI ${isPrompt ? 'description' : 'tags'}... This can take a moment.`;
        statusMessage.style.color = '#e0e0e0';

        fetch(`/api/generation/caption/${imageId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source: source }) // Pass the specific source
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || 'Unknown error'); });
            }
            return response.json();
        })
        .then(data => {
            statusMessage.textContent = 'Successfully generated and saved! Reloading...';
            statusMessage.style.color = '#81c784';
            setTimeout(() => { window.location.reload(); }, 1000);
        })
        .catch(error => {
            console.error('Error generating AI content:', error);
            statusMessage.textContent = `Error: ${error.message}`;
            statusMessage.style.color = '#e57373';
        })
        .finally(() => {
            // Restore button even on failure
            buttonElement.innerHTML = originalIconSVG;
            buttonElement.classList.remove('loading');
            buttonElement.disabled = false;
        });
    }

    function enterEditMode() {
        editorPanel.classList.add('edit-mode');
    }

    function leaveEditMode() {
        editorPanel.classList.remove('edit-mode');
        statusMessage.textContent = '';
        // Note: We don't reset the form on cancel in case the user
        // wants to re-enter edit mode without losing their changes.
    }

    function handleGenerateCaption() {
        if (!confirm("This will overwrite the current prompt and add new tags. Are you sure you want to continue?")) {
            return;
        }

        const originalButtonHtml = generateCaptionButton.innerHTML;
        generateCaptionButton.innerHTML = "Generating...";
        generateCaptionButton.disabled = true;
        statusMessage.textContent = 'Requesting AI caption... This may take a moment.';
        statusMessage.style.color = '#e0e0e0';

        fetch(`/api/generation/caption/${imageId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.detail || 'Unknown error'); });
            }
            return response.json();
        })
        .then(data => {
            statusMessage.textContent = 'Successfully generated and saved! Reloading...';
            statusMessage.style.color = '#81c784';
            setTimeout(() => { window.location.reload(); }, 1500);
        })
        .catch(error => {
            console.error('Error:', error);
            statusMessage.textContent = `Error generating caption: ${error.message}`;
            statusMessage.style.color = '#e57373';
            generateCaptionButton.innerHTML = originalButtonHtml;
            generateCaptionButton.disabled = false;
        });
    }

     function saveChanges() {
        const formData = new FormData(editForm);
        const updateData = {};

        // Define which keys should be treated as integers or floats
        const integerFields = ['seed', 'steps'];
        const floatFields = ['cfg_scale'];

        for (const [key, value] of formData.entries()) {
            const trimmedValue = value.trim();

            if (integerFields.includes(key)) {
                // If it's an integer field and not empty, parse it. Otherwise, set to null.
                updateData[key] = trimmedValue !== '' ? parseInt(trimmedValue, 10) : null;
            } else if (floatFields.includes(key)) {
                // If it's a float field and not empty, parse it. Otherwise, set to null.
                updateData[key] = trimmedValue !== '' ? parseFloat(trimmedValue) : null;
            } else if (key === 'album_id') {
                // Handle album_id separately as before
                updateData[key] = trimmedValue === '' ? null : parseInt(trimmedValue, 10);
            } else {
                // All other fields are treated as strings
                updateData[key] = value;
            }
        }

        // Handle the boolean checkbox separately
        updateData['is_nsfw'] = editForm.elements['is_nsfw'].checked;
        
        // Final check for NaN values from failed parsing (e.g., user enters "abc" in a number field)
        for (const key in updateData) {
            if (typeof updateData[key] === 'number' && isNaN(updateData[key])) {
                updateData[key] = null; // Convert any invalid numbers to null
            }
        }
        
        statusMessage.textContent = 'Saving...';
        statusMessage.style.color = '#e0e0eota';

        fetch(`/api/images/${imageId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { 
                    // Create a readable error string from the validation response
                    let errorMsg = err.detail || 'Unknown error';
                    if (Array.isArray(err.detail)) {
                       errorMsg = err.detail.map(e => e.msg).join('; ');
                    }
                    throw new Error(errorMsg); 
                });
            }
            return response.json();
        })
        .then(updatedImage => {
            statusMessage.textContent = 'Successfully saved! Reloading...';
            statusMessage.style.color = '#81c784';
            setTimeout(() => { window.location.reload(); }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            statusMessage.textContent = `Error: ${error.message}`;
            statusMessage.style.color = '#e57373';
        });
    }
});
</script>
{% endblock %}