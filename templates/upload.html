<!-- In templates/upload.html, REPLACE the entire file with this new structure -->

{% extends "base.html" %}

{% block title %}Bulk Upload{% endblock %}

{% block content %}
<h1>Bulk Upload</h1>
<p>Select multiple images or videos. Metadata and options below will be applied to all uploaded files.</p>

<div class="upload-grid-bulk">
    <!-- Column 1: Batch Metadata & Actions -->
    <div class="upload-col-metadata">
        <h2>Batch Options</h2>
        <!-- We use a 'form' tag here just to group the inputs, not for submission -->
        <form id="batch-metadata-form">
            <div class="form-group">
                <label for="tags">Add Tags (comma-separated)</label>
                <input type="text" id="tags" name="tags" placeholder="e.g. character, cyberpunk, futuristic">
            </div>
            <div class="form-group">
                <label for="album_id">Add to Album (Optional)</label>
                <select name="album_id" id="album_id">
                    <option value="">-- No Album --</option>
                    {% if albums %}
                        {% for album in albums %}
                        <option value="{{ album.id }}">{{ album.name }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="form-group form-group-checkbox">
                <input type="checkbox" id="is_nsfw" name="is_nsfw" value="on">
                <label for="is_nsfw">Mark all images as NSFW (18+)</label>
            </div>
            <div class="form-actions">
                <button type="button" id="start-upload-button" class="button-primary">Start Upload</button>
            </div>
        </form>
         <div id="global-progress-container" class="progress-container" style="display: none;">
            <p id="global-progress-text">Uploading 1 of 5...</p>
            <div class="progress-bar-outer">
                <div id="global-progress-bar" class="progress-bar-inner"></div>
            </div>
        </div>
    </div>
    
    <!-- Column 2: File Queue -->
    <div class="upload-col-queue">
        <!-- The file input triggers the queue display -->
        <div class="file-input-wrapper">
            <label for="file-input-bulk" class="button">Select Files</label>
            <input type="file" id="file-input-bulk" name="files" accept="image/png, image/jpeg, image/webp, video/mp4, video/webm" multiple>
        </div>
        
        <div id="upload-queue-container">
            <!-- JavaScript will populate this area with selected files -->
            <p id="queue-placeholder">No files selected.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<!-- Add the specific styles for the bulk upload page -->
<style>
    .upload-grid-bulk { display: grid; grid-template-columns: 350px 1fr; gap: 2.5rem; align-items: flex-start; }
    .upload-col-queue { min-height: 400px; }
    .file-input-wrapper { text-align: center; margin-bottom: 1.5rem; }
    #file-input-bulk { display: none; } /* Hide the actual input */
    .file-input-wrapper label { display: inline-block; cursor: pointer; }
    
    #upload-queue-container {
        display: flex; flex-direction: column; gap: 1rem;
        border: 2px dashed #444; border-radius: 8px;
        padding: 1rem; min-height: 300px;
    }
    .queue-item {
        display: flex; align-items: center; gap: 1rem;
        background-color: #333; padding: 0.5rem; border-radius: 4px;
        border-left: 4px solid #555; /* Status indicator */
    }
    .queue-item.status-uploading { border-left-color: #64b5f6; }
    .queue-item.status-success { border-left-color: #81c784; }
    .queue-item.status-error { border-left-color: #e57373; }

    .queue-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0; background-color: #252525;}
    .queue-info { flex-grow: 1; }
    .queue-info .filename { font-weight: bold; margin: 0; font-size: 0.9em; word-break: break-all; }
    .queue-info .status-text { margin: 0; font-size: 0.8em; color: #aaa; }
    .queue-remove-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 1.5em; padding: 0 .5rem; }
    .queue-remove-btn:hover { color: #e57373; }
    
    .progress-container { margin-top: 1rem; }
    .progress-bar-outer { width: 100%; background-color: #2a2a2a; border-radius: 4px; padding: 3px; border: 1px solid #444; }
    .progress-bar-inner { height: 12px; background-color: #64b5f6; border-radius: 2px; width: 0%; transition: width 0.2s ease-out; }

    @media (max-width: 900px) { .upload-grid-bulk { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block scripts_extra %}
<!-- This script is entirely new for this page -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- DOM Elements ---
    const fileInput = document.getElementById("file-input-bulk");
    const queueContainer = document.getElementById("upload-queue-container");
    const placeholder = document.getElementById("queue-placeholder");
    const metadataForm = document.getElementById("batch-metadata-form");
    const startUploadButton = document.getElementById("start-upload-button");

    const progressContainer = document.getElementById("global-progress-container");
    const progressText = document.getElementById("global-progress-text");
    const progressBar = document.getElementById("global-progress-bar");

    // --- State ---
    let filesToUpload = []; // Use an array to manage File objects

    // --- Event Listeners ---
    fileInput.addEventListener("change", handleFileSelection);
    queueContainer.addEventListener("click", handleQueueClick);
    startUploadButton.addEventListener("click", processUploadQueue);

    // --- Functions ---
    function handleFileSelection(event) {
        const selectedFiles = Array.from(event.target.files);
        selectedFiles.forEach(file => {
            const fileId = `file-${Math.random().toString(36).substr(2, 9)}`;
            filesToUpload.push({ id: fileId, file: file });
            addFileToQueueUI(fileId, file);
        });
        if (filesToUpload.length > 0) placeholder.style.display = "none";
        
        // Clear the input value to allow re-selecting the same files
        fileInput.value = "";
    }

    function addFileToQueueUI(fileId, file) {
        const objectURL = URL.createObjectURL(file);
        const mediaTag = file.type.startsWith('image/')
            ? `<img src="${objectURL}" class="queue-preview" alt="Preview">`
            : `<video src="${objectURL}" class="queue-preview" muted playsinline></video>`;

        const itemHTML = `
            <div class="queue-item" id="${fileId}" data-status="pending">
                ${mediaTag}
                <div class="queue-info">
                    <p class="filename">${file.name}</p>
                    <p class="status-text">Pending</p>
                </div>
                <button type="button" class="queue-remove-btn" title="Remove from queue">&times;</button>
            </div>`;
        queueContainer.insertAdjacentHTML('beforeend', itemHTML);
    }

    function handleQueueClick(event) {
        const removeButton = event.target.closest('.queue-remove-btn');
        if (!removeButton) return;
        
        const queueItem = removeButton.closest('.queue-item');
        const fileIdToRemove = queueItem.id;
        
        // Remove from UI
        queueItem.remove();
        
        // Remove from internal state array
        filesToUpload = filesToUpload.filter(f => f.id !== fileIdToRemove);
        
        if (filesToUpload.length === 0) placeholder.style.display = "block";
    }

    async function processUploadQueue() {
        if (filesToUpload.length === 0) {
            alert("Please select files to upload.");
            return;
        }

        startUploadButton.disabled = true;
        startUploadButton.textContent = "Uploading...";
        progressContainer.style.display = "block";

        const totalFiles = filesToUpload.length;
        for (let i = 0; i < totalFiles; i++) {
            const fileData = filesToUpload[i];
            const queueItemElement = document.getElementById(fileData.id);
            const statusTextElement = queueItemElement.querySelector('.status-text');
            
            progressText.textContent = `Uploading ${i + 1} of ${totalFiles}: ${fileData.file.name}`;
            progressBar.style.width = `${((i + 1) / totalFiles) * 100}%`;
            
            updateQueueItemStatus(queueItemElement, statusTextElement, "uploading", "Uploading...");

            try {
                // Prepare FormData for this specific file
                const formData = new FormData();
                formData.append('file', fileData.file);
                formData.append('original_filename', fileData.file.name);
                
                // Append batch metadata
                const batchData = new FormData(metadataForm);
                for (const [key, value] of batchData.entries()) {
                    formData.append(key, value);
                }

                // Call the single-file API endpoint
                const response = await fetch("{{ url_for('handle_single_upload_api') }}", {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "Upload failed");
                }

                const result = await response.json();
                const detailUrl = `/image/${result.id}`;
                updateQueueItemStatus(queueItemElement, statusTextElement, "success", `Success! <a href="${detailUrl}" target="_blank">View Image</a>`);
                // Disable the remove button on success
                queueItemElement.querySelector('.queue-remove-btn').disabled = true;

            } catch (error) {
                console.error(`Failed to upload ${fileData.file.name}:`, error);
                updateQueueItemStatus(queueItemElement, statusTextElement, "error", `Error: ${error.message}`);
            }
        }
        
        progressText.textContent = "Upload complete!";
        startUploadButton.textContent = "Upload More";
        startUploadButton.disabled = false;
        filesToUpload = []; // Clear the queue after processing
    }

    function updateQueueItemStatus(itemElement, textElement, status, message) {
        itemElement.dataset.status = status; // for styling
        textElement.innerHTML = message; // use innerHTML to allow for links
        itemElement.className = 'queue-item'; // Reset classes
        itemElement.classList.add(`status-${status}`);
    }
});
</script>
{% endblock %}