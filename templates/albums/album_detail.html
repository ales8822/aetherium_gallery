<!-- templates/albums/album_detail.html (Final Version with Drag-and-Drop) -->
{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}


{% block content %}
<div class="header-with-action">
    <div>
        <h1>{{ album.name }}</h1>
        <p class="album-description">{{ album.description or "No description provided for this album."}}</p>
    </div>
    <!-- ▼▼▼ ADD A BUTTON TO TOGGLE REORDERING MODE ▼▼▼ -->
    <button type="button" id="reorder-button" class="button">Reorder Images</button>
</div>

<p class="search-summary">
    Displaying <strong>{{ image_count }}</strong> images.
</p>

{% if images %}
    <!-- 
      We give the grid a specific ID so our JavaScript can find it easily.
      We also add a data-album-id to store the album's ID for the API call.
    -->
    <div id="album-grid-sortable" data-album-id="{{ album.id }}">
        {% include 'partials/gallery_grid.html' %}
    </div>
    <div id="reorder-status" style="margin-top: 1rem; font-weight: bold; text-align: center;"></div>
{% else %}
    <p>This album is currently empty. You can add images using the 'Select' tool in the main gallery.</p>
{% endif %}

<!-- The bulk actions panel is still useful here -->
{% include 'partials/bulk_actions_panel.html' %}

{% endblock %}


{% block scripts_extra %}
<!-- ▼▼▼ ADD THIS ENTIRE SCRIPT BLOCK ▼▼▼ -->
<!-- 1. Include the SortableJS library from a CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const reorderButton = document.getElementById('reorder-button');
    const galleryGrid = document.getElementById('album-grid-sortable');
    const statusDiv = document.getElementById('reorder-status');
    const albumId = galleryGrid ? galleryGrid.dataset.albumId : null;
    let sortableInstance = null; // To hold the SortableJS instance

    if (reorderButton && galleryGrid) {
        reorderButton.addEventListener('click', toggleReorderMode);
    }

    function toggleReorderMode() {
        if (sortableInstance) {
            // If it's already active, destroy it to turn off reordering
            sortableInstance.destroy();
            sortableInstance = null;
            galleryGrid.classList.remove('reordering-active');
            reorderButton.textContent = 'Reorder Images';
            reorderButton.classList.remove('active');
            statusDiv.textContent = '';
        } else {
            // If it's not active, create it to enable reordering
            sortableInstance = new Sortable(galleryGrid.querySelector('.gallery-grid'), {
                animation: 150, // Animation speed
                ghostClass: 'sortable-ghost', // Class for the drop placeholder
                onEnd: handleDrop, // Function to call when dragging ends
            });

            galleryGrid.classList.add('reordering-active');
            reorderButton.textContent = 'Finish Reordering';
            reorderButton.classList.add('active');
            statusDiv.textContent = 'Drag and drop images to change their order.';
        }
    }

    async function handleDrop(event) {
        if (!albumId) {
            console.error("Album ID is missing.");
            return;
        }

        // Get the new order of all items in the grid by their data-id
        const imageElements = Array.from(galleryGrid.querySelectorAll('.gallery-item'));
        const orderedImageIds = imageElements.map(item => parseInt(item.dataset.id, 10));

        statusDiv.textContent = 'Saving new order...';
        statusDiv.style.color = '#e0e0e0';

        try {
            const response = await fetch(`/api/album/${albumId}/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_ids: orderedImageIds }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'An unknown error occurred.');
            }

            const result = await response.json();
            statusDiv.textContent = 'Order saved successfully!';
            statusDiv.style.color = '#81c784'; // Green for success
        
        } catch (error) {
            console.error('Failed to save order:', error);
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.style.color = '#e57373'; // Red for error
        }
    }
});
</script>
{% endblock %}