<!-- templates/albums/album_detail.html (UPDATED with Frontend Fix) -->
{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}


{% block content %}
<div class="header-with-action">
    <div>
        <h1>{{ album.name }}</h1>
        <p class="album-description">{{ album.description or "No description provided for this album."}}</p>
    </div>
    <div class="button-group">
        <button type="button" id="analyze-button" class="button">Analyze Aesthetic</button>
        <button type="button" id="reorder-button" class="button">Reorder Images</button>
    </div>
</div>

<p class="search-summary">
    Displaying <strong>{{ image_count }}</strong> images.
</p>

{% if images %}
    <div id="album-grid-sortable" data-album-id="{{ album.id }}">
        {% include 'partials/gallery_grid.html' %}
    </div>
    <div id="reorder-status" style="margin-top: 1rem; font-weight: bold; text-align: center;"></div>
{% else %}
    <p>This album is currently empty. You can add images using the 'Select' tool in the main gallery.</p>
{% endif %}


<div id="suggestions-container" class="suggestions-container" style="display: none;">
    <h2 id="suggestions-title">Suggested Additions</h2>
    <p id="suggestions-status">Analyzing this album's aesthetic to find matching images in your gallery...</p>
    <div id="suggestions-grid" class="gallery-grid">
        <!-- Suggestions will be dynamically inserted here -->
    </div>
</div>

{% include 'partials/bulk_actions_panel.html' %}
{% endblock %}


{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- DRAG AND DROP REORDERING LOGIC ---
    const reorderButton = document.getElementById('reorder-button');
    const galleryGrid = document.getElementById('album-grid-sortable');
    const statusDiv = document.getElementById('reorder-status');
    const albumId = galleryGrid ? galleryGrid.dataset.albumId : null;
    let sortableInstance = null; 

    if (reorderButton && galleryGrid) {
        reorderButton.addEventListener('click', toggleReorderMode);
    }

    function toggleReorderMode() {
        if (sortableInstance) {
            sortableInstance.destroy();
            sortableInstance = null;
            galleryGrid.classList.remove('reordering-active');
            reorderButton.textContent = 'Reorder Images';
            reorderButton.classList.remove('active');
            statusDiv.textContent = '';
        } else {
            sortableInstance = new Sortable(galleryGrid.querySelector('.gallery-grid'), { animation: 150, ghostClass: 'sortable-ghost', onEnd: handleDrop });
            galleryGrid.classList.add('reordering-active');
            reorderButton.textContent = 'Finish Reordering';
            reorderButton.classList.add('active');
            statusDiv.textContent = 'Drag and drop images to change their order.';
        }
    }

    async function handleDrop(event) {
        if (!albumId) { console.error("Album ID is missing."); return; }
        const imageElements = Array.from(galleryGrid.querySelectorAll('.gallery-item'));
        const orderedImageIds = imageElements.map(item => parseInt(item.dataset.id, 10));
        statusDiv.textContent = 'Saving new order...';
        statusDiv.style.color = '#e0e0e0';
        try {
            const response = await fetch(`/api/album/${albumId}/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_ids: orderedImageIds }),
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'An unknown error occurred.');
            }
            statusDiv.textContent = 'Order saved successfully!';
            statusDiv.style.color = '#81c784';
        } catch (error) {
            console.error('Failed to save order:', error);
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.style.color = '#e57373';
        }
    }

    // --- "CREATIVE DIRECTOR" LOGIC ---
    const analyzeButton = document.getElementById('analyze-button');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const suggestionsStatus = document.getElementById('suggestions-status');
    const suggestionsGrid = document.getElementById('suggestions-grid');

    analyzeButton.addEventListener('click', fetchSuggestions);

    async function fetchSuggestions() {
        if (!albumId) { console.error("Album ID is missing for suggestions."); return; }

        suggestionsGrid.innerHTML = '';
        suggestionsStatus.textContent = "Analyzing this album's aesthetic to find matching images in your gallery...";
        suggestionsContainer.style.display = 'block';
        analyzeButton.disabled = true;
        analyzeButton.classList.add('loading');

        try {
            const response = await fetch(`/api/album/${albumId}/suggestions`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Failed to fetch suggestions.");
            }
            const suggestedImages = await response.json();
            if (suggestedImages.length === 0) {
                suggestionsStatus.textContent = "No new matching images were found in your gallery.";
            } else {
                suggestionsStatus.textContent = `Found ${suggestedImages.length} images that might be a great fit for this album!`;
                renderSuggestions(suggestedImages);
            }
        
        } catch(error) {
            console.error('Failed to fetch suggestions:', error);
            suggestionsStatus.textContent = `An error occurred: ${error.message}`;
            suggestionsStatus.style.color = '#e57373';
        } finally {
            analyzeButton.disabled = false;
            analyzeButton.classList.remove('loading');
        }
    }

    function renderSuggestions(images) {
            suggestionsGrid.innerHTML = images.map(image => {
                // THE FIX IS HERE: We manually prepend '/uploads/' to create the correct absolute URL path.
                const thumbnailUrl = `/uploads/${image.thumbnail_path}`; 

                const videoIndicator = image.is_video ? '<span class="video-indicator">â–¶</span>' : '';
                const nsfwClass = image.is_nsfw ? 'is-nsfw' : '';

                return `
                    <div class="gallery-item ${nsfwClass}" data-id="${image.id}" data-type="${image.is_video ? 'video' : 'image'}">
                        <a href="/image/${image.id}">
                            <img src="${thumbnailUrl}" alt="${image.prompt || 'Gallery image'}" loading="lazy">
                            ${videoIndicator}
                            <div class="select-checkbox"></div>
                        </a>
                    </div>
                `;
            }).join('');
        }
});
</script>
{% endblock %}