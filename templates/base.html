<!-- templates/base.html (Corrected Logic) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Aetherium Gallery{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}" />
    
    <!-- Styles for the toggle switch (Unchanged) -->
    <style>
      .safe-mode-toggle { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;}
      .toggle-switch {
        position: relative; display: inline-block;
        width: 44px; height: 24px;
      }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .slider {
        position: absolute; cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #555;
        border-radius: 24px;
        transition: .4s;
      }
      .slider:before {
        position: absolute; content: "";
        height: 18px; width: 18px;
        left: 3px; bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: .4s;
      }
      /* This logic is now consistent: NOT checked = NSFW mode (red) */
      input:not(:checked) + .slider { background-color: #e57373; }
      /* CHECKED = SFW mode (green) */
      input:checked + .slider { background-color: #81c784; } 
      
      input:checked + .slider:before { transform: translateX(20px); }

      .media-filter-group {
    display: flex;
    align-items: center;
    background-color: #333;
    border-radius: 6px;
    border: 1px solid #555;
    overflow: hidden; /* Ensures the rounded corners apply to the children */
    }
    .media-filter-button {
        background: none;
        border: none;
        color: #ccc;
        padding: 0.4rem 1rem;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: bold;
        border-left: 1px solid #555;
        transition: all 0.2s ease;
    }
    .media-filter-button:first-child {
        border-left: none; /* No border on the first button */
    }
    .media-filter-button:hover {
        background-color: #444;
    }
    .media-filter-button.active {
        background-color: #64b5f6;
        color: #111;
    }
    </style>
    {% block head_extra %}{% endblock %}
  </head>
  <body>
    <header>
      <nav>
        <a href="{{ url_for('gallery_index') }}">Aetherium Gallery</a>
        <ul>
          <li><a href="{{ url_for('gallery_index') }}">Gallery</a></li>
          <li><a href="{{ url_for('list_albums') }}">Albums</a></li>
          <li><a href="{{ url_for('view_stats') }}">Stats</a></li>
          <li><a href="{{ url_for('upload_form') }}">Upload</a></li>

          <li>
            <label for="safe-mode-checkbox" class="safe-mode-toggle" title="Toggle Safe Mode">
              <span>NSFW</span>
              <div class="toggle-switch">
                <!--
                  ▼▼▼ LOGIC CORRECTION 1 ▼▼▼
                  The checkbox is now CHECKED when safe_mode from the backend is true.
                  This makes the initial state match the JavaScript's expectation.
                -->
                <input type="checkbox" id="safe-mode-checkbox" {% if safe_mode %}checked{% endif %}>
                <span class="slider"></span>
              </div>
              <span>SFW</span>
            </label>
          </li>
          <li>
            <div id="media-filter" class="media-filter-group">
                <button class="media-filter-button {% if media_filter == 'all' %}active{% endif %}" data-filter="all">All</button>
                <button class="media-filter-button {% if media_filter == 'image' %}active{% endif %}" data-filter="image">Images</button>
                <button class="media-filter-button {% if media_filter == 'video' %}active{% endif %}" data-filter="video">Videos</button>
            </div>
          </li>
          <!-- ▼▼▼ ADD THIS NEW LIST ITEM ▼▼▼ -->
          <li>
            <form action="{{ url_for('search') }}" method="get" class="search-form">
              <input type="search" name="q" placeholder="Search prompts..." required minlength="2">
              <button type="submit">Search</button>
            </form>
          </li>
          <li>
            <button type="button" id="select-mode-button" class="select-mode-button">Select</button>
          </li>

        </ul>
      </nav>
    </header>

    <main>{% block content %} {% endblock %}</main>

    <footer>
      <p>© {{ now().year }} Aetherium Gallery</p>
    </footer>

    <!-- Inline script block for Safe Mode -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('safe-mode-checkbox');

        if (toggle) {
          toggle.addEventListener('change', () => {
            /* 
              ▼▼▼ LOGIC CORRECTION 2 ▼▼▼
              This logic is now correct and consistent with the display.
              - If the box IS CHECKED, it means "SFW is on", so set cookie to 'on'.
              - If the box IS NOT CHECKED, it means "SFW is off", so set cookie to 'off'.
            */
            const safeModeValue = toggle.checked ? 'on' : 'off';
            
            // Set a cookie that expires in 30 days
            document.cookie = `safe_mode=${safeModeValue};path=/;max-age=2592000;samesite=Lax`;
            
            // Reload the page to apply the filter
            window.location.reload();
          });
        }
        
        const mediaFilterGroup = document.getElementById('media-filter');
        if (mediaFilterGroup) {
            mediaFilterGroup.addEventListener('click', (event) => {
                // Check if a filter button was clicked
                const button = event.target.closest('.media-filter-button');
                if (!button) return;

                const filterValue = button.dataset.filter;
                
                // Set a cookie for the media filter preference
                document.cookie = `media_filter=${filterValue};path=/;max-age=2592000;samesite=Lax`;

                // Reload the page to apply the new filter
                window.location.reload();
            });
        }
      });
    </script>
    
   <!-- templates/base.html (Final, Complete Script) -->

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Get all required elements ---
    const selectModeButton = document.getElementById('select-mode-button');
    const bulkActionsPanel = document.getElementById('bulk-actions-panel');
    const selectedCountSpan = document.getElementById('selected-count');
    const galleryGrid = document.querySelector('.gallery-grid');

    // --- Action Panel Elements ---
    const bulkAddTagsInput = document.getElementById('bulk-add-tags');
    const bulkAddTagsButton = document.getElementById('bulk-action-add-tags');
    const bulkAddToAlbumSelect = document.getElementById('bulk-add-to-album');
    const bulkAddToAlbumButton = document.getElementById('bulk-action-add-to-album');
    const bulkSetNsfwButton = document.getElementById('bulk-action-set-nsfw');
    const bulkDeleteButton = document.getElementById('bulk-action-delete');
    
    // --- State Variables ---
    let selectedImageIds = new Set();
    let isSelectionMode = false;

    // --- GLOBAL EVENT LISTENERS ---
    if (selectModeButton) {
        selectModeButton.addEventListener('click', toggleSelectionMode);
    }
    if (galleryGrid) {
        galleryGrid.addEventListener('click', handleGalleryClick);
    }
    // Action Button Listeners
    if (bulkAddTagsButton) { /* ... listener code ... */ }
    if (bulkAddToAlbumButton) { /* ... listener code ... */ }
    if (bulkSetNsfwButton) { /* ... listener code ... */ }
    if (bulkDeleteButton) { /* ... listener code ... */ }

    // --- MASTER CLICK HANDLER ---
    function handleGalleryClick(event) {
        const clickedItem = event.target.closest('.gallery-item');
        if (!clickedItem) return;

        // --- Selection Mode Logic ---
        if (isSelectionMode) {
            event.preventDefault();
            event.stopPropagation();
            const imageId = parseInt(clickedItem.dataset.id, 10);
            if (!imageId) return;
            toggleItemSelection(clickedItem, imageId);
            updateActionsPanel();
            return;
        }
        
        // --- Normal Mode Logic ---
        const galleryLink = event.target.closest('.gallery-link');
        const infoIcon = event.target.closest('.info-icon');

        if (infoIcon) {
            event.preventDefault();
            event.stopPropagation();
            showInfoLightbox(infoIcon);
            return;
        }
        
        if (galleryLink) {
            event.preventDefault();
            showImageLightbox(galleryLink);
        }
    }
    
    // --- UI HELPER FUNCTIONS ---
    // (These functions are all complete from previous steps)
    function toggleSelectionMode() { /* ... */ }
    function toggleItemSelection(item, id) { /* ... */ }
    function updateActionsPanel() { /* ... */ }
    function clearSelection() { /* ... */ }
    
    // --- LIGHTBOX FUNCTIONS (FROM YOUR INDEX.HTML) ---
    function showImageLightbox(linkElement) {
        const mediaUrl = linkElement.dataset.fullImageUrl;
        const detailPageUrl = linkElement.href;
        const filename = linkElement.querySelector('.overlay .filename').textContent;
        const isVideo = linkElement.dataset.isVideo === 'true';
        const videoType = linkElement.dataset.videoType;
        let mediaHtml;

        if (isVideo) {
            mediaHtml = `<video controls autoplay muted loop playsinline style="max-width: 90vw; max-height: 85vh; display: block;"><source src="${mediaUrl}" type="${videoType}"></video>`;
        } else {
            mediaHtml = `<img src="${mediaUrl}" style="max-width: 90vw; max-height: 85vh;">`;
        }

        const contentHtml = `<div class="image-lightbox-container">${mediaHtml}<div class="lightbox-caption"><span class="lightbox-filename">${filename}</span><a href="${detailPageUrl}" class="lightbox-details-button">Details & Actions</a></div></div>`;
        basicLightbox.create(contentHtml).show();
    }

    function showInfoLightbox(iconElement) {
        const data = iconElement.dataset;
        const contentHtml = `<div class="info-lightbox-content"><h3>${data.filename}</h3><dl><dt>Dimensions</dt><dd>${data.dimensions || 'N/A'}</dd><dt>Sampler</dt><dd>${data.sampler || 'N/A'}</dd><dt>Steps</dt><dd>${data.steps || 'N/A'}</dd><dt>CFG Scale</dt><dd>${data.cfg || 'N/A'}</dd>${data.prompt ? `<dt>Prompt</dt><dd class="prompt">${data.prompt}</dd>` : ''}${data.negativePrompt ? `<dt>Negative Prompt</dt><dd class="prompt">${data.negativePrompt}</dd>` : ''}</dl></div>`;
        basicLightbox.create(contentHtml).show();
    }

    // --- BULK ACTION API FUNCTION ---
    async function performBulkAction(action, value = null) {
        // ... (This function is complete from previous steps)
    }

    /* Paste in full function bodies here for clarity */
    function toggleSelectionMode() {isSelectionMode = !isSelectionMode; document.body.classList.toggle('selection-mode-active', isSelectionMode); selectModeButton.classList.toggle('active', isSelectionMode); selectModeButton.textContent = isSelectionMode ? 'Cancel Selection' : 'Select'; if (!isSelectionMode) { clearSelection(); }}
    function toggleItemSelection(item, id) {if (selectedImageIds.has(id)) {selectedImageIds.delete(id); item.classList.remove('selected');} else {selectedImageIds.add(id); item.classList.add('selected');}}
    function updateActionsPanel() {const count = selectedImageIds.size; if (selectedCountSpan) selectedCountSpan.textContent = count; if (bulkActionsPanel) bulkActionsPanel.classList.toggle('visible', count > 0);}
    function clearSelection() {document.querySelectorAll('.gallery-item.selected').forEach(item => item.classList.remove('selected')); selectedImageIds.clear(); updateActionsPanel();}
    async function performBulkAction(action, value = null) { const ids = Array.from(selectedImageIds); if (ids.length === 0) return; const body = { image_ids: ids, action: action, value: value }; document.body.style.cursor = 'wait'; try { const response = await fetch('/api/images/bulk-update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), }); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'An unknown error occurred.'); } const result = await response.json(); alert(`Success: ${result.message}`); window.location.reload(); } catch (error) { console.error('Bulk action failed:', error); alert(`Error: ${error.message}`); } finally { document.body.style.cursor = 'default'; }}
    if (bulkAddTagsButton) { bulkAddTagsButton.addEventListener('click', () => { const tags = bulkAddTagsInput.value.trim(); if (tags) performBulkAction('add_tags', tags); else alert('Please enter tags to add.'); }); }
    if (bulkAddToAlbumButton) { bulkAddToAlbumButton.addEventListener('click', () => { const albumId = bulkAddToAlbumSelect.value; performBulkAction('add_to_album', albumId === 'null' ? null : parseInt(albumId)); }); }
    if (bulkSetNsfwButton) { bulkSetNsfwButton.addEventListener('click', () => performBulkAction('set_nsfw', true)); }
    if (bulkDeleteButton) { bulkDeleteButton.addEventListener('click', () => { if (confirm(`Are you sure you want to delete ${selectedImageIds.size} selected images? This cannot be undone.`)) { performBulkAction('delete'); } }); }
});
</script>
{% endblock %}
  </body>
</html>